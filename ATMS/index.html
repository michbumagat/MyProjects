<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>ATM Carousel Pop-up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body{margin:0;font-family:system-ui,sans-serif}
    #map{width:100vw;height:100vh}
    .cluster-icon{background:#0066cc;color:#fff;border-radius:50%;text-align:center;line-height:32px;font-weight:bold;border:2px solid #fff;box-shadow:0 0 3px #0004;}
    table{border-collapse:collapse;font-size:13px;width:100%}
    td{padding:3px 6px;border-bottom:1px solid #e0e0e0}
    td:first-child{font-weight:bold;white-space:nowrap}
    /* carousel arrows */
    .carousel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-size:14px;}
    .arrow-btn{background:#f0f0f0;border:1px solid #ccc;border-radius:3px;padding:2px 6px;cursor:pointer;}
    .arrow-btn:disabled{background:#e0e0e0;color:#999;cursor:not-allowed;}
  </style>
</head>
<body>
<div id="map"></div>

<script>
fetch('atms.geojson')
  .then(r => r.json())
  .then(data => {
    const map = L.map('map').setView([45.4, -75.7], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'© OpenStreetMap contributors'
    }).addTo(map);

    function propsHtml(props) {
      const rows = Object.entries(props)
        .map(([k,v])=>`<tr><td>${k}</td><td>${v??''}</td></tr>`)
        .join('');
      return `<table>${rows}</table>`;
    }

    /* ---------- ultra-light cluster (4 ATMs) ---------- */
    function simpleCluster(features, radius) {
      const grid = Math.floor(radius / 1000);
      const buckets = {};
      features.forEach(f => {
        const key = [
          Math.floor(f.geometry.coordinates[0] * grid),
          Math.floor(f.geometry.coordinates[1] * grid)
        ].join(',');
        if (!buckets[key]) buckets[key] = [];
        buckets[key].push(f);
      });
      return Object.entries(buckets).map(([k, pts]) => ({
        type: 'Feature',
        geometry: { type: 'Point', coordinates: [pts[0].geometry.coordinates[0], pts[0].geometry.coordinates[1]] },
        properties: { cluster: true, point_count: pts.length, points: pts }
      }));
    }

    const clusters = simpleCluster(data.features, 6000);
    const layer = L.layerGroup().addTo(map);

    clusters.forEach(c => {
      if (c.properties.cluster && c.properties.point_count > 1) {
        const count = c.properties.point_count;
        const size = 30 + 1.2 * Math.sqrt(count);
        const icon = L.divIcon({
          html: `<div class="cluster-icon" style="width:${size}px;height:${size}px;line-height:${size}px">${count}</div>`,
          className: ''
        });
        const m = L.marker([c.geometry.coordinates[1], c.geometry.coordinates[0]], {icon});
        m.on('click', function () {
          const pts = c.properties.points;
          let idx = 0;
          function showPopup() {
            const p = pts[idx];
            const content = `
              <div class="carousel-header">
                <button class="arrow-btn" id="prevBtn" ${idx === 0 ? 'disabled' : ''}>←</button>
                <span>ATM ${idx + 1} of ${pts.length}</span>
                <button class="arrow-btn" id="nextBtn" ${idx === pts.length - 1 ? 'disabled' : ''}>→</button>
              </div>
              ${propsHtml(p.properties)}
            `;
            const popup = L.popup({maxWidth: 350}).setContent(content);
            m.unbindPopup().bindPopup(popup).openPopup();
            // wire arrows after DOM exists
            setTimeout(() => {
              document.getElementById('prevBtn')?.addEventListener('click', () => {
                if (idx > 0) { idx--; showPopup(); }
              });
              document.getElementById('nextBtn')?.addEventListener('click', () => {
                if (idx < pts.length - 1) { idx++; showPopup(); }
              });
            }, 0);
          }
          showPopup();
        });
        m.bindTooltip(`${count} ATMs`, {direction: 'top'});
        layer.addLayer(m);
      } else {
        const p = c.properties.points[0];
        const m = L.circleMarker([p.geometry.coordinates[1], p.geometry.coordinates[0]], {
          radius: 6, color: '#0066cc', fillOpacity: 0.9
        });
        m.bindPopup(propsHtml(p.properties));
        m.bindTooltip(`${p.properties.Name ?? p.properties.address ?? 'ATM'}`, {direction: 'top'});
        layer.addLayer(m);
      }
    });
    if (layer.getLayers().length) map.fitBounds(layer.getBounds().pad(0.05));
  })
  .catch(console.error);
</script>
</body>
</html>